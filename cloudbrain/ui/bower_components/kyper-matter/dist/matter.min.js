function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}();!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("lodash"),require("jwt-decode"),require("superagent")):"function"==typeof define&&define.amd?define(["lodash","jwt-decode","superagent"],t):e.Matter=t(e._,e.jwtDecode,e.superagent)}(this,function(e,t,r){"use strict";function n(e,t){return e&&console[e]?console[e].apply(console,t):console.log.apply(console,t)}function o(t){var r="",n={};e.isObject(t)?("debug"==c&&e.has(t,"func")&&(r+=e.has(t,"obj")?"["+t.obj+"."+t.func+"()]\n ":e.has(t,"file")?"["+t.file+" > "+t.func+"()]\n ":"["+t.func+"()]\n "),e.each(e.omit(e.keys(t)),function(o,i,s){"func"!=o&&"obj"!=o&&("description"==o||"message"==o?r+=t[o]:n[o]=e.isString(t[o])?t[o]:t[o])}),r+="\n"):e.isString(t)&&(r=t);var o=[r,n];return o}function i(e){var r=void 0;if(e&&""!=e)try{r=t(e)}catch(n){throw d.error({description:"Error decoding token.",data:r,error:n,func:"decodeToken",file:"token"}),new Error("Invalid token string.")}return r}function s(e){return new Promise(function(t,r){e.end(function(e,n){return e?(401==e.status&&d.warn({description:"Unauthorized. You must be signed into make this request.",func:"handleResponse"}),e&&e.response?r(e.response.text):(d.warn({description:"Unauthorized. You must be signed into make this request.",error:e,func:"handleResponse"}),r(e))):t(n.body)})})}function a(e){return g.string&&(e=e.set("Authorization","Bearer "+g.string),console.info({message:"Set auth header",func:"addAuthHeader",file:"request"})),e}e="default"in e?e["default"]:e,t="default"in t?t["default"]:t,r="default"in r?r["default"]:r;var u={serverUrl:"http://tessellate.elasticbeanstalk.com",tokenName:"tessellate",tokenDataName:"tessellate-tokenData",tokenUserDataName:"tessellate-currentUser"},c="debug";u.logLevel&&(c=u.logLevel);var d={log:function(e){var t=o(e);"production"==u.envName?n("log",t):n("log",t)},info:function(e){var t=o(e);"production"==u.envName?n("info",t):n("info",t)},warn:function(e){var t=o(e);"production"==u.envName?n("warn",t):n("warn",t)},debug:function(e){var t=o(e);"production"==u.envName||n("debug",t)},error:function(e){var t=o(e);"production"==u.envName?n("error",t):n("error",t)}},l={loadCss:function(e){if(document){var t=document.createElement("link");return t.rel="stylesheet",t.type="text/css",t.href=e,document.getElementsByTagName("head")[0].insertBefore(t,document.getElementsByTagName("head")[0].firstChild),d.log({description:"CSS was loaded into document.",element:t,func:"loadCss",obj:"dom"}),t}throw d.error({description:"Document does not exsist to load assets into.",func:"loadCss",obj:"dom"}),new Error("Document object is required to load assets.")},loadJs:function(t){if(window&&!e.has(window,"document"))throw d.error({description:"Document does not exsist to load assets into.",func:"loadCss",obj:"dom"}),new Error("Document object is required to load assets.");var r=window.document.createElement("script");return r.src=t,r.type="text/javascript",window.document.getElementsByTagName("head")[0].appendChild(r),d.log({description:"JS was loaded into document.",element:r,func:"loadCss",obj:"dom"}),r},asyncLoadJs:function(t){if(e.has(window,"document")){var r=window.document.createElement("script");return r.src=t,r.type="text/javascript",window.document.getElementsByTagName("head")[0].appendChild(r),d.log({description:"JS was loaded into document.",element:r,func:"loadCss",obj:"dom"}),new Promise(function(e,t){window.setTimeout(e,30)})}throw d.error({description:"Document does not exsist to load assets into.",func:"loadCss",obj:"dom"}),new Error("Document object is required to load assets.")}},p={},f=Object.defineProperties({item:function(e,t){return this.setItem(e,t)},setItem:function(t,r){p[t]=r,this.localExists&&(e.isObject(r)&&(r=JSON.stringify(r)),window.sessionStorage.setItem(t,r))},getItem:function(e){if(p[e])return p[e];if(this.localExists){var t=window.sessionStorage.getItem(e);if(t){var r=!1,n=null;try{n=JSON.parse(t),r=!0}catch(o){r=!1}if(r)return n}return t}return null},removeItem:function(e){if(p[e]&&(p[e]=null),this.localExists)try{window.sessionStorage.removeItem(e)}catch(t){d.error({description:"Error removing item from session storage",error:t,obj:"storage",func:"removeItem"})}},clear:function(){if(p={},this.localExists)try{window.sessionStorage.clear()}catch(e){d.warn("Session storage could not be cleared.",e)}}},{localExists:{get:function(){var e="test";if("undefined"==typeof window||"undefined"==typeof window.sessionStorage)return!1;try{return window.sessionStorage.setItem(e,"1"),window.sessionStorage.removeItem(e),!0}catch(t){return d.error({description:"Error saving to session storage",error:t,obj:"storage",func:"localExists"}),!1}},configurable:!0,enumerable:!0}}),g=Object.defineProperties({save:function(e){this.string=e},"delete":function(){f.removeItem(u.tokenName),f.removeItem(u.tokenDataName),d.log({description:"Token was removed.",func:"delete",obj:"token"})}},{string:{get:function(){return f.getItem(u.tokenName)},set:function(r){var n=void 0;if(e.isString(r))n=r;else{if(d.log({description:"Token data is not string.",token:r,func:"string",obj:"token"}),!e.isObject(r)||!e.has(r,"token"))return void d.error({description:"Invalid value set to token.",token:r,func:"string",obj:"token"});n=r.token}d.log({description:"Token was set.",token:r,tokenStr:n,func:"string",obj:"token"}),f.setItem(u.tokenName,n),this.data=t(n)},configurable:!0,enumerable:!0},data:{get:function(){return f.getItem(u.tokenDataName)?f.getItem(u.tokenDataName):i(this.string)},set:function(t){if(e.isString(t)){var r=t;t=i(r),d.info({description:"Token data was set as string. Decoding token.",token:r,tokenData:t,func:"data",obj:"token"})}else d.log({description:"Token data was set.",data:t,func:"data",obj:"token"}),f.setItem(u.tokenDataName,t)},configurable:!0,enumerable:!0}}),m={get:function(e,t){var n=r.get(e);return t&&n.query(t),n=a(n),s(n)},post:function(e,t){var n=r.post(e).send(t);return n=a(n),s(n)},put:function(e,t){var n=r.put(e).send(t);return n=a(n),s(n)},del:function(e,t){var n=r.put(e).send(t);return n=a(n),s(n)}},h={},v=function(){function e(t){_classCallCheck(this,e),this.app=t.app?t.app:null,this.redirectUri=t.redirectUri?t.redirectUri:"redirect.html",this.provider=t.provider?t.provider:null}return _createClass(e,[{key:"loadHello",value:function(){return window&&!window.hello?l.asyncLoadJs("https://s3.amazonaws.com/kyper-cdn/js/hello.js"):Promise.resolve()}},{key:"helloLoginListener",value:function(){window.hello.on("auth.login",function(e){d.info({description:"User logged in to google.",func:"loadHello",obj:"Google"}),window.hello(e.network).api("/me").then(function(t){var r=t;return r.provider=e.network,m.post(this.endpoint+"/provider",r).then(function(e){return d.log({description:"Provider request successful.",response:e,func:"signup",obj:"GoogleUtil"}),e})["catch"](function(e){return d.error({description:"Error requesting login.",error:e,func:"signup",obj:"Matter"}),Promise.reject(e)})})})}},{key:"initHello",value:function(){var e=this;return this.loadHello().then(function(){return m.get(e.app.endpoint+"/providers").then(function(t){d.log({description:"Provider request successful.",response:t,func:"signup",obj:"ProviderAuth"});var r=t[e.provider];return d.warn({description:"Provider found",provider:r,func:"login",obj:"ProviderAuth"}),r?(d.warn({description:"Providers config built",providersConfig:t,func:"login",obj:"ProviderAuth"}),window.hello.init(t,{redirect_uri:"redirect.html"})):(d.error({description:"Provider is not setup. Visit tessellate.kyper.io to enter your client id for "+e.provider,provider:e.provider,clientIds:h,func:"login",obj:"ProviderAuth"}),Promise.reject({message:"Provider is not setup."}))})["catch"](function(e){return d.error({description:"Getting application data.",error:e,func:"signup",obj:"Matter"}),Promise.reject(e)})})}},{key:"login",value:function(){var e=this;return this.initHello().then(function(){return window.hello.login(e.provider)})}},{key:"signup",value:function(){var e=this;return this.initHello().then(function(){return window.hello.login(e.provider)},function(e){return d.error({description:"Error signing up.",error:e,func:"signup",obj:"Matter"}),Promise.reject({message:"Error signing up."})})}}]),e}(),w=function(){function t(e,r){if(_classCallCheck(this,t),!e)throw d.error({description:"Application name requires to use Matter.",func:"constructor",obj:"Matter"}),new Error("Application name is required to use Matter");this.name=e,r&&(this.options=r)}return _createClass(t,[{key:"signup",value:function(t){if(d.log({description:"Signup called.",signupData:t,func:"signup",obj:"Matter"}),!t)return d.error({description:"Signup information is required to signup.",func:"signup",obj:"Matter"}),Promise.reject({message:"Login data is required to login."});if(e.isObject(t))return m.post(this.endpoint+"/signup",t).then(function(r){return d.log({description:"Account request successful.",signupData:t,response:r,func:"signup",obj:"Matter"}),e.has(r,"account")?r.account:(d.warn({description:"Account was not contained in signup response.",signupData:t,response:r,func:"signup",obj:"Matter"}),r)})["catch"](function(e){return d.error({description:"Error requesting signup.",signupData:t,error:e,func:"signup",obj:"Matter"}),Promise.reject(e)});if(e.isString(t)){var r=new v({provider:t,app:this});return r.signup(t).then(function(e){return d.info({description:"Provider signup successful.",provider:t,res:e,func:"signup",obj:"Matter"}),Promise.resolve(e)})}return d.error({description:"Incorrectly formatted signup information.",signupData:t,func:"signup",obj:"Matter"}),Promise.reject({message:"Signup requires an object or a string."})}},{key:"login",value:function(t){var r=this;if(!t)return d.error({description:"Username/Email and Password are required to login",func:"login",obj:"Matter"}),Promise.reject({message:"Login data is required to login."});if(e.isObject(t))return t.password&&t.username?m.put(this.endpoint+"/login",t).then(function(t){return e.has(t,"data")&&e.has(t.data,"status")&&409==t.data.status?(d.warn({description:"Account not found.",response:t,func:"login",obj:"Matter"}),Promise.reject(t.data)):(d.log({description:"Successful login.",response:t,func:"login",obj:"Matter"}),e.has(t,"token")&&(r.token.string=t.token),e.has(t,"account")&&r.storage.setItem(u.tokenUserDataName,t.account),t.account)})["catch"](function(e){return d.error({description:"Error requesting login.",error:e,status:e.status,func:"login",obj:"Matter"}),(409==e.status||400==e.status)&&(e=e.response.text),Promise.reject(e)}):Promise.reject({message:"Username/Email and Password are required to login"});if(e.isString(t)){var n=new v({provider:t,app:this});return n.login().then(function(e){return d.info({description:"Provider login successful.",provider:t,res:e,func:"login",obj:"Matter"}),Promise.resolve(e)})}return d.error({description:"Incorrectly fomatted login information.",signupData:signupData,func:"login",obj:"Matter"}),Promise.reject({message:"Login requires an object or a string."})}},{key:"logout",value:function(){var e=this;return this.isLoggedIn?m.put(this.endpoint+"/logout").then(function(t){return d.log({description:"Logout successful.",response:t,func:"logout",obj:"Matter"}),e.currentUser=null,e.token["delete"](),t})["catch"](function(t){return d.error({description:"Error requesting log out: ",error:t,func:"logout",obj:"Matter"}),e.storage.removeItem(u.tokenUserDataName),e.token["delete"](),Promise.reject(t)}):(d.warn({description:"No logged in account to log out.",func:"logout",obj:"Matter"}),Promise.reject({message:"No logged in account to log out."}))}},{key:"getCurrentUser",value:function(){var e=this;return this.storage.item(u.tokenUserDataName)?Promise.resove(this.storage.getItem(u.tokenUserDataName)):this.isLoggedIn?m.get(this.endpoint+"/user").then(function(t){return d.log({description:"Current User Request responded.",responseData:t,func:"currentUser",obj:"Matter"}),e.currentUser=t,t})["catch"](function(e){return 401==e.status?(d.warn({description:"Called for current user without token.",error:e,func:"currentUser",obj:"Matter"}),g["delete"](),Promise.resolve(null)):(d.error({description:"Error requesting current user.",error:e,func:"currentUser",obj:"Matter"}),Promise.reject(e))}):Promise.resolve(null)}},{key:"updateProfile",value:function(e){var t=this;return this.isLoggedIn?(d.warn({description:"Calling update endpoint.",endpoint:this.endpoint+"/user/"+this.token.data.username,func:"updateProfile",obj:"Matter"}),m.put(this.endpoint+"/user/"+this.token.data.username,e).then(function(e){return d.log({description:"Update profile request responded.",responseData:e,func:"updateProfile",obj:"Matter"}),t.currentUser=e,e})["catch"](function(e){return d.error({description:"Error requesting current user.",error:e,func:"updateProfile",obj:"Matter"}),Promise.reject(e)})):(d.error({description:"No current user profile to update.",func:"updateProfile",obj:"Matter"}),Promise.reject({message:"Must be logged in to update profile."}))}},{key:"changePassword",value:function(){var e=this;return this.isLoggedIn?(d.log({description:"Calling update endpoint to change password.",endpoint:this.endpoint+"/user/"+this.token.data.username,func:"changePassword",obj:"Matter"}),m.put(this.endpoint+"/user/"+this.token.data.username,updateData).then(function(t){return d.log({description:"Update password request responded.",responseData:t,func:"changePassword",obj:"Matter"}),e.currentUser=t,t})["catch"](function(e){return d.error({description:"Error requesting password change.",error:e,func:"changePassword",obj:"Matter"}),Promise.reject(e)})):(d.error({description:"No current user profile for which to change password.",func:"changePassword",obj:"Matter"}),Promise.reject({message:"Must be logged in to change password."}))}},{key:"recoverPassword",value:function(){var e=this;return this.isLoggedIn?(d.log({description:"Calling recover password endpoint.",endpoint:this.endpoint+"/user/"+this.token.data.username,func:"recoverPassword",obj:"Matter"}),m.put(this.endpoint+"/account/"+this.token.data.username+"/recover",updateData).then(function(t){return d.log({description:"Recover password request responded.",responseData:t,func:"recoverPassword",obj:"Matter"}),e.currentUser=t,t})["catch"](function(e){return d.error({description:"Error requesting password recovery.",error:e,func:"recoverPassword",obj:"Matter"}),Promise.reject(e)})):(d.error({description:"No current user for which to recover password.",func:"recoverPassword",obj:"Matter"}),Promise.reject({message:"Must be logged in to recover password."}))}},{key:"isInGroup",value:function(t){var r=this;if(!this.isLoggedIn)return d.log({description:"No logged in user to check.",func:"isInGroup",obj:"Matter"}),!1;if(!t||!e.isString(t))return t&&e.isArray(t)?(d.info({description:"Array of groups.",list:t,func:"isInGroup",obj:"Matter"}),this.isInGroups(t)):!1;var n=function(){var n=t,o=n.split(",");if(o.length>1)return d.info({description:"String list of groups.",list:o,func:"isInGroup",obj:"Matter"}),{v:r.isInGroups(o)};var i=r.token.data.groups||[];return d.log({description:"Checking if user is in group.",group:n,userGroups:r.token.data.groups||[],func:"isInGroup",obj:"Matter"}),{v:e.any(i,function(e){return n==e.name})}}();return"object"==typeof n?n.v:void 0}},{key:"isInGroups",value:function(t){var r=this;if(t&&e.isArray(t))return e.map(t,function(t){return r.isInGroup(e.isString(t)?t:t.name)});if(t&&e.isString(t)){var n=t.split(",");return n.length>1?this.isInGroups(n):this.isInGroup(n[0])}d.error({description:"Invalid groups list.",func:"isInGroups",obj:"Matter"})}},{key:"endpoint",get:function(){var t=u.serverUrl;return e.has(this,"options")&&this.options.localServer&&(t="http://localhost:4000",d.info({description:"LocalServer option was set to true. Now server url is local server.",url:t,func:"endpoint",obj:"Matter"})),"tessellate"==this.name?"undefined"!=typeof window&&e.has(window,"location")&&window.location.host===t&&(t="",d.info({description:"Host is Server, serverUrl simplified!",url:t,func:"endpoint",obj:"Matter"})):(t=t+"/apps/"+this.name,d.log({description:"Server url set.",url:t,func:"endpoint",obj:"Matter"})),t}},{key:"currentUser",set:function(e){d.log({description:"Current User set.",user:e,func:"currentUser",obj:"Matter"}),this.storage.setItem(u.tokenUserDataName,e)},get:function(){return this.storage.getItem(u.tokenUserDataName)?this.storage.getItem(u.tokenUserDataName):null}},{key:"storage",get:function(){return f}},{key:"token",get:function(){return g}},{key:"utils",get:function(){return{logger:d,request:m,storage:f,dom:l}}},{key:"isLoggedIn",get:function(){return this.token.string?!0:!1}}]),t}();return w});
//# sourceMappingURL=matter.min.js.map